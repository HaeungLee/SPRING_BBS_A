<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<title>ê²Œì‹œê¸€ ìƒì„¸ë³´ê¸°</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body {
	min-height: 100vh;
	margin: 0;
	background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
	font-family: 'Pretendard', 'Segoe UI', Arial, sans-serif;
	color: #222;
}

.view-container {
	max-width: 900px;
	margin: 48px auto 0 auto;
	background: #fff;
	border-radius: 20px;
	box-shadow: 0 8px 32px rgba(33, 150, 243, 0.10), 0 1.5px 6px
		rgba(33, 150, 243, 0.08);
	padding: 36px 36px 28px 36px;
}

.view-header {
	margin-bottom: 24px;
	border-bottom: 2px solid #e3f2fd;
	padding-bottom: 12px;
}

.view-header h2 {
	margin: 0;
	color: #1565c0;
	font-weight: 800;
	font-size: 2rem;
	letter-spacing: 1px;
}

.view-meta {
	font-size: 1rem;
	color: #1976d2;
	margin-top: 8px;
	font-weight: 500;
	display: flex;
	gap: 18px;
	flex-wrap: wrap;
}

.main-image-container {
	width: 100%;
	margin: 26px 0 18px 0;
	text-align: center;
}

.main-image {
	max-width: 100%;
	max-height: 420px;
	border-radius: 12px;
	box-shadow: 0 2px 12px rgba(33, 150, 243, 0.10);
	background: #f7fbff;
}

.view-content {
	margin: 28px 0 24px 0;
	white-space: pre-wrap;
	font-size: 1.08rem;
	color: #222;
	line-height: 1.7;
}

#post-map {
	width: 100%;
	height: 320px;
	margin: 18px 0 28px 0;
	border-radius: 12px;
	box-shadow: 0 1.5px 8px rgba(33, 150, 243, 0.06);
	background: #f7fbff;
}

.attached-files {
	background-color: #f0f6fb;
	padding: 14px 18px;
	border-radius: 8px;
	margin-top: 18px;
	font-size: 1rem;
	color: #1565c0;
	box-shadow: 0 1px 4px rgba(33, 150, 243, 0.04);
}

.attached-files ul {
	padding-left: 18px;
	margin: 8px 0 0 0;
}

.attached-files li {
	margin: 4px 0;
	font-size: 0.98rem;
}

.attached-files a {
	color: #1976d2;
	text-decoration: underline;
	font-weight: 500;
	transition: color .2s;
}

.attached-files a:hover {
	color: #0d47a1;
}

.btn-group {
	margin-top: 34px;
	display: flex;
	gap: 12px;
	flex-wrap: wrap;
}

.btn {
	padding: 10px 28px;
	border: none;
	border-radius: 999px;
	text-decoration: none;
	color: #fff;
	font-size: 1rem;
	font-weight: 700;
	cursor: pointer;
	box-shadow: 0 2px 8px rgba(33, 150, 243, 0.10);
	transition: background .2s, transform .1s;
	display: inline-block;
}

.btn-back {
	background: linear-gradient(90deg, #90caf9 0%, #42a5f5 100%);
	color: #1565c0;
}

.btn-back:hover {
	background: linear-gradient(90deg, #42a5f5 0%, #90caf9 100%);
	color: #0d47a1;
}

.btn-edit {
	background: linear-gradient(90deg, #66bb6a 0%, #388e3c 100%);
}

.btn-edit:hover, .edit-btn:hover {
	background: linear-gradient(90deg, #388e3c 0%, #66bb6a 100%);
	color: #fff;
}

.btn-delete, .delete-btn {
	background: linear-gradient(90deg, #e57373 0%, #d32f2f 100%);
	color: #fff;
}

.btn-delete:hover, .delete-btn:hover {
	background: linear-gradient(90deg, #d32f2f 0%, #e57373 100%);
	color: #fff;
}
/* ëŒ“ê¸€ ì˜ì—­ */
.comment-section {
	margin-top: 48px;
	background: #e3f2fd;
	border-radius: 14px;
	padding: 24px 22px 22px 22px;
	box-shadow: 0 1.5px 8px rgba(33, 150, 243, 0.06);
	max-width: 800px;
	margin-left: auto;
	margin-right: auto;
}

.comment-section h3 {
	margin-top: 0;
	color: #1565c0;
	font-weight: 700;
	font-size: 1.15rem;
	letter-spacing: 0.5px;
}

.comment-form-outer {
	position: relative;
	background: #e3f2fd;
	border-radius: 14px;
	padding: 28px 22px 60px 22px;
	margin-bottom: 44px;
	max-width: 800px;
	margin-left: auto;
	margin-right: auto;
}

textarea#commentContent {
	width: 100%;
	height: 90px;
	padding: 28px 16px;
	border-radius: 10px;
	border: 1px solid #bbdefb;
	font-size: 1.1rem;
	resize: none;
	box-sizing: border-box;
	line-height: 1.7;
	background: #fff;
}

textarea#commentContent:focus {
	border-color: #42a5f5;
	outline: none;
}

.mini-btn, .comment-submit-btn, .reply-submit-btn, .reply-cancel-btn,
	.reply-btn, .edit-btn, .delete-btn {
	padding: 6px 16px;
	font-size: 0.95rem;
	border-radius: 999px;
	border: none;
	font-weight: 600;
	margin: 2px 2px 0 0;
	cursor: pointer;
	transition: background 0.18s, color 0.18s;
	background: #e3f2fd;
	color: #1976d2;
	box-shadow: none;
	display: inline-block;
}

.mini-btn:hover, .comment-submit-btn:hover, .reply-submit-btn:hover,
	.reply-btn:hover {
	background: #bbdefb;
	color: #0d47a1;
}

.comment-submit-btn {
	background: #42a5f5;
	color: #fff;
	position: absolute;
	right: 26px;
	bottom: 18px;
	margin: 0;
}

.comment-submit-btn:hover {
	background: #1976d2;
	color: #fff;
}

.reply-submit-btn {
	background: #42a5f5;
	color: #fff;
}

.reply-submit-btn:hover {
	background: #1976d2;
	color: #fff;
}

.reply-cancel-btn {
	background: #f0f0f0;
	color: #666;
}

.reply-cancel-btn:hover {
	background: #e0e0e0;
	color: #222;
}

.reply-btn {
	background: #e3f2fd;
	color: #1976d2;
}

.reply-btn:hover {
	background: #bbdefb;
	color: #0d47a1;
}

.edit-btn {
	background: #a5d6a7;
	color: #1b5e20;
}

.edit-btn:hover {
	background: #43a047;
	color: #fff;
}

.delete-btn {
	background: #f8bbd0;
	color: #c2185b;
}

.delete-btn:hover {
	background: #e57373;
	color: #fff;
}
/* ëŒ“ê¸€ ìŠ¤íƒ€ì¼ */
.comment-block {
	background-color: #fff;
	border-radius: 12px;
	padding: 16px;
	margin-bottom: 12px;
	box-shadow: 0 2px 10px rgba(33, 150, 243, 0.1);
	display: flex;
	flex-direction: column;
}

.comment-header {
	display: flex;
	align-items: center;
	gap: 8px;
	margin-bottom: 4px;
}

.comment-nickname {
	font-weight: 700;
	color: #1565c0;
	font-size: 1.05rem;
	margin-right: 2px;
}

.comment-like-btn {
	padding: 2px 10px;
	font-size: 1rem;
	border-radius: 8px;
	border: none;
	background: #e3f2fd;
	color: #1976d2;
	margin-left: 6px;
	cursor: pointer;
	font-weight: 600;
	transition: background 0.18s, color 0.18s;
	vertical-align: middle;
	display: inline-flex;
	align-items: center;
	height: 28px;
}

.comment-like-btn:hover {
	background: #bbdefb;
	color: #0d47a1;
}

.comment-date {
	color: #888;
	font-size: 0.92rem;
	margin-left: 10px;
}

.comment-content {
	color: #333;
	font-size: 1rem;
	margin-bottom: 8px;
	word-wrap: break-word;
}

.comment-actions {
	display: flex;
	gap: 8px;
	margin-top: 2px;
	justify-content: flex-end;
	align-items: center;
}

.deleted-comment {
	color: #aaa;
	font-style: italic;
}
/* ë‹µê¸€ ì…ë ¥ì°½ ê³ ì • ìŠ¤íƒ€ì¼ */
.reply-input {
	margin-top: 12px;
	background: #ffffff;
	padding: 10px;
	border-radius: 10px;
	box-shadow: 0 1px 4px rgba(33, 150, 243, 0.05);
	position: relative;
}

.reply-input textarea {
	width: 100%;
	height: 90px;
	padding: 28px 16px;
	border-radius: 10px;
	border: 1px solid #bbdefb;
	font-size: 1.1rem;
	resize: none;
	box-sizing: border-box;
	line-height: 1.7;
	background: #fff;
}

.reply-btn-group {
	display: flex;
	justify-content: flex-end;
	gap: 8px;
	margin-top: 0;
}
/* ìˆ˜ì • ì…ë ¥ì°½ ìŠ¤íƒ€ì¼ - reply-inputì™€ ë™ì¼ ìŠ¤íƒ€ì¼ ì ìš© */
.edit-input {
	margin-top: 12px;
	background: #ffffff;
	padding: 10px;
	border-radius: 10px;
	box-shadow: 0 1px 4px rgba(33, 150, 243, 0.05);
	position: relative;
}

.edit-input textarea {
	width: 100%;
	height: 90px;
	padding: 28px 16px;
	border-radius: 10px;
	border: 1px solid #bbdefb;
	font-size: 1.1rem;
	resize: none;
	box-sizing: border-box;
	line-height: 1.7;
	background: #fff;
}

.edit-input textarea:focus {
	border-color: #42a5f5;
	outline: none;
}
/* ë°˜ì‘í˜• ë””ìì¸ */
@media ( max-width : 600px) {
	.view-container {
		padding: 10px 2vw 18px 2vw;
	}
	.view-header h2 {
		font-size: 1.2rem;
	}
	.main-image {
		max-height: 220px;
	}
	.btn, .btn-group .btn, .mini-btn, .comment-submit-btn, .reply-submit-btn,
		.reply-cancel-btn, .reply-btn, .edit-btn, .delete-btn {
		font-size: 0.88rem;
		padding: 6px 10px;
	}
	textarea#commentContent, .reply-input textarea, .edit-input textarea {
		font-size: 0.95rem;
		height: 64px;
		padding: 18px 10px;
	}
	.comment-submit-btn {
		right: 14px;
		bottom: 10px;
	}
}

.image-modal {
	position: fixed;
	z-index: 9999;
	top: 0;
	left: 0;
	width: 100vw;
	height: 100vh;
	display: none;
	justify-content: center;
	align-items: center;
	background: rgba(0, 0, 0, 0.8);
}

.image-modal img {
	max-width: 90%;
	max-height: 90%;
	border: 4px solid white;
	border-radius: 8px;
}

.image-modal .close {
	position: absolute;
	top: 20px;
	right: 30px;
	font-size: 36px;
	color: white;
	cursor: pointer;
}
.content-image-modal {
  position: fixed;
  z-index: 99998;
  top: 0; left: 0;
  width: 100vw;
  height: 100vh;
  background: rgba(0, 0, 0, 0.85);
  display: none;
  justify-content: center;
  align-items: center;
}

.content-image-modal img {
  max-width: 90%;
  max-height: 90%;
}

.content-image-modal .close {
  position: absolute;
  top: 20px;
  right: 30px;
  font-size: 36px;
  color: white;
  cursor: pointer;
}
#commentSubmitBtn[disabled] {
  background: #cccccc;
  cursor: not-allowed;
  opacity: 0.7;
}

</style>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script type="text/javascript"
	src="//dapi.kakao.com/v2/maps/sdk.js?appkey=6cf3d7111812f0d90ad76a99a16d0f39&autoload=false&libraries=services"></script>
</head>
<body>
	<div class="view-container">
		<div class="view-header">
			<h2 th:utext="${post.title}">ê²Œì‹œê¸€ ì œëª©</h2>
			<div class="view-meta">
				<span>ì‘ì„±ì: <span th:utext="${post.nickname}"></span></span> <span>ì§€ì—­:
					<span th:utext="${post.region}"></span>
				</span> <span>ì¡°íšŒìˆ˜: <span th:utext="${post.views}"></span></span>
			</div>
		</div>
		<div th:if="${mainImage != null}" class="main-image-container">
			<img th:src="@{/file/preview/{fileId}(fileId=${mainImage.fileId})}"
				class="main-image" th:alt="${mainImage.fileOriginName}">
		</div>
		<!-- view-content ì´ë¯¸ì§€ìš© ëª¨ë‹¬ì°½ -->
		<div id="contentImageModal" class="content-image-modal"
			style="display: none;">
			<span class="close" onclick="closeContentImageModal()">&times;</span>
			<img id="contentModalImage" src="" alt="ë³¸ë¬¸ ì´ë¯¸ì§€ í™•ëŒ€">
		</div>

		<div class="view-content" th:utext="${post.content}">ê²Œì‹œê¸€ ë‚´ìš©</div>
		<div id="post-map"></div>
		<div class="attached-files"
			th:if="${post.files != null and !post.files.isEmpty()}">
			<strong>ì²¨ë¶€íŒŒì¼:</strong>
			<ul>
				<li th:each="file : ${post.files}"><a
					th:href="@{/file/download/{fileId}(fileId=${file.fileId})}"
					th:text="${file.fileOriginName}"></a> <span
					th:text="${#numbers.formatInteger(file.fileSize/1024, 1, 'COMMA')} + ' KB'"></span>
					<button type="button" class="preview-button"
						th:attr="data-fileid=${file.fileId}, data-filename=${file.fileOriginName}">
						ë¯¸ë¦¬ë³´ê¸°</button></li>
			</ul>
		</div>
		<div id="previewModal" class="image-modal" style="display: none;">
			<span class="close" onclick="closePreviewModal()">&times;</span>
			<div id="previewContent"
				style="max-width: 90%; max-height: 90%; background: #fff; padding: 10px; border-radius: 10px;">
				<!-- ì—¬ê¸° ì•ˆì— ë¯¸ë¦¬ë³´ê¸°ê°€ ë“¤ì–´ê° -->
			</div>
		</div>
		<div class="btn-group">
			<a th:href="@{/post/list}" class="btn btn-back">ëª©ë¡ìœ¼ë¡œ</a>
			<th:block th:if="${post.user_id} == ${sessionUserId}">
				<a th:href="@{/post/edit/{id}(id=${post.post_id})}"
					class="btn btn-edit">ìˆ˜ì •</a>
				<form th:action="@{/post/delete/{id}(id=${post.post_id})}"
					method="post" style="display: inline;">
					<button type="submit" class="btn btn-delete"
						onclick="return confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?');">ì‚­ì œ</button>
				</form>
			</th:block>
		</div>
		<div class="comment-section">
			<h3>ëŒ“ê¸€</h3>
			<div th:if="${user_id != null}">
				<div class="comment-form-outer">
					<textarea id="commentContent" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
					<button class="mini-btn comment-submit-btn"
				        onclick="submitComment()"
				        id="commentSubmitBtn">ëŒ“ê¸€ ë“±ë¡</button>
				</div>
			</div>
			<div th:unless="${user_id != null}">
				<p>
					ëŒ“ê¸€ì„ ì‘ì„±í•˜ë ¤ë©´ <a
						th:href="@{/login(returnUrl=${'/post/view/' + post.post_id})}">ë¡œê·¸ì¸</a>ì´
					í•„ìš”í•©ë‹ˆë‹¤.
				</p>
			</div>
			<div id="commentList"></div>
		</div>
	</div>
	<script th:inline="javascript">
const postId = [[${post.post_id}]];
const currentUserId = [[${user_id}]];
const latitude = [[${post.lat}]];
const longitude = [[${post.lng}]];
const csrfToken = [[${_csrf != null ? _csrf.token : ''}]];
const csrfHeader = [[${_csrf != null ? _csrf.headerName : 'X-CSRF-TOKEN'}]];
const isLoggedIn = [[${session.userId != null}]];

$.ajaxSetup({
  beforeSend: function(xhr) {
    if (csrfToken) {
      xhr.setRequestHeader(csrfHeader, csrfToken);
    }
  }
});

let isSubmitting = false;

function submitComment() {
  if (isSubmitting) return; // ì´ë¯¸ ì œì¶œ ì¤‘ì´ë©´ ë¬´ì‹œ

  const btn = document.getElementById('commentSubmitBtn');
  const content = $('#commentContent').val();

  if (!content.trim()) {
    alert('ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”.');
    return;
  }

  isSubmitting = true;
  btn.disabled = true;
  btn.textContent = 'ë“±ë¡ ì¤‘...';

  $.ajax({
    url: '/api/comments',
    method: 'POST',
    contentType: 'application/json',
    xhrFields: { withCredentials: true },
    data: JSON.stringify({ content: content, post_id: postId }),
    success: function() {
      $('#commentContent').val('');
      loadComments();
    },
    error: function(xhr) {
      if (xhr.status === 401) {
        alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
        window.location.href = '/login';
      } else {
        alert('ëŒ“ê¸€ ë“±ë¡ ì‹¤íŒ¨');
      }
    },
    complete: function() {
      isSubmitting = false;
      btn.disabled = false;
      btn.textContent = 'ëŒ“ê¸€ ë“±ë¡';
    }
  });
}

function loadComments() {
	  $.ajax({
	    url: '/api/comments/' + postId,
	    method: 'GET',
	    success: function(comments) {
	      let html = '';
	      const commentMap = {};
	      comments.forEach(comment => {
	        commentMap[comment.comment_id] = comment;
	        comment.replies = [];
	      });
	      const roots = [];
	      comments.forEach(comment => {
	        if (comment.parent_id) {
	          const parent = commentMap[comment.parent_id];
	          if (parent) parent.replies.push(comment);
	        } else {
	          roots.push(comment);
	        }
	      });
	      function renderComments(commentList, depth) {
	        commentList.forEach(comment => {
	          const marginLeft = depth * 20;
	          html += `<div class="comment-block" data-id="${comment.comment_id}" style="margin-left:${marginLeft}px;">`;
	          html += `<div class="comment-header">`;
	          html += `<span class="comment-nickname">${comment.nickname || 'ìµëª…'}</span>`;
	          if (!comment.is_deleted) {
	            html += `<button class="comment-like-btn" onclick="toggleLike(${comment.comment_id})">ğŸ‘ (${comment.like_count || 0})</button>`;
	          }
	          html += `<span class="comment-date">${comment.created_at?.replace('T', ' ').substring(0,19) || ''}</span>`;
	          html += `</div>`;
	          if (comment.is_deleted) {
	              html += `<div class="deleted-comment">ì‚­ì œëœ ëŒ“ê¸€ì…ë‹ˆë‹¤.</div>`;
	          } else {
	              html += `<div class="comment-content">${comment.content}</div>`;
	          }
	          if (!comment.is_deleted) {
	            html += `<div class="comment-actions">`;
	            if (currentUserId && comment.user_id === currentUserId) {
	              // oldContent ì¸ì ì œê±°
	              html += `<button class="mini-btn edit-btn" onclick="editComment(${comment.comment_id})">ìˆ˜ì •</button>`;
	              html += `<button class="mini-btn delete-btn" onclick="deleteComment(${comment.comment_id})">ì‚­ì œ</button>`;
	            }
	            if (currentUserId) {
	              html += `<button class="mini-btn reply-btn" onclick="replyComment(${comment.comment_id})">ë‹µê¸€</button>`;
	            }
	            html += `</div>`;
	          }
	          html += `</div>`;
	          if (comment.replies.length > 0) {
	            renderComments(comment.replies, depth + 1);
	          }
	        });
	      }
	      renderComments(roots, 0);
	      $('#commentList').html(html);
	    },
	    error: function() {
	      alert('ëŒ“ê¸€ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨');
	    }
	  });
	}

function toggleLike(commentId) {
  $.ajax({
    url: '/api/comments/' + commentId + '/like',
    method: 'POST',
    xhrFields: { withCredentials: true },
    success: function() {
        loadComments();
    },
    error: function(xhr) {
      if (xhr.status === 401) {
        alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
        window.location.href = '/login';
      } else {
        alert('ì¢‹ì•„ìš” ì‹¤íŒ¨');
      }
    }
  });
}

function deleteComment(commentId) {
  if (!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  $.ajax({
    url: '/api/comments/' + commentId,
    method: 'DELETE',
    xhrFields: { withCredentials: true },
    success: function() {
        loadComments();
    },
    error: function() {
      alert('ëŒ“ê¸€ ì‚­ì œ ì‹¤íŒ¨');
    }
  });
}

function editComment(commentId) {
	  const commentBlock = $(`.comment-block[data-id="${commentId}"]`);
	  const contentDiv = commentBlock.find('.comment-content');
	  const editBtn = commentBlock.find('.edit-btn');
	  const currentContent = contentDiv.text().trim(); // ìµœì‹  ëŒ“ê¸€ ë‚´ìš© ê°€ì ¸ì˜¤ê¸°

	  if (editBtn.text() === 'ì·¨ì†Œ') {
	    const originalContent = editBtn.data('original-content');
	    contentDiv.text(originalContent).show();
	    editBtn.text('ìˆ˜ì •');
	    commentBlock.find('.edit-input').remove();
	    return;
	  }

	  editBtn.data('original-content', currentContent);
	  contentDiv.hide();
	  const editForm = `
	    <div class="edit-input">
	      <textarea class="edit-textarea" rows="2">${currentContent}</textarea>
	      <div class="reply-btn-group">
	        <button class="mini-btn reply-submit-btn">ìˆ˜ì • ì™„ë£Œ</button>
	        <button class="mini-btn reply-cancel-btn">ì·¨ì†Œ</button>
	      </div>
	    </div>
	  `;
	  contentDiv.after(editForm);
	  editBtn.text('ì·¨ì†Œ');
	  commentBlock.find('.edit-textarea').focus(); // textareaì— í¬ì»¤ìŠ¤

	  commentBlock.find('.reply-submit-btn').on('click', function() {
	    const newContent = commentBlock.find('.edit-textarea').val().trim();
	    if (!newContent) {
	      alert('ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.');
	      return;
	    }
	    $.ajax({
	      url: `/api/comments/${commentId}`,
	      method: 'PUT',
	      contentType: 'application/json',
	      xhrFields: { withCredentials: true },
	      data: JSON.stringify({ content: newContent }),
	      success: function() {
	        contentDiv.text(newContent).show();
	        editBtn.text('ìˆ˜ì •');
	        commentBlock.find('.edit-input').remove();
	      },
	      error: function() {
	        alert('ëŒ“ê¸€ ìˆ˜ì • ì‹¤íŒ¨');
	      }
	    });
	  });

	  commentBlock.find('.reply-cancel-btn').on('click', function() {
	    contentDiv.text(currentContent).show();
	    editBtn.text('ìˆ˜ì •');
	    commentBlock.find('.edit-input').remove();
	  });
	}
	
function replyComment(parentId) {
  $('.reply-input').remove();
  const replyBox = `
    <div class="reply-input">
      <textarea class="reply-textarea" rows="2" placeholder="ë‹µê¸€ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
      <div class="reply-btn-group">
        <button class="mini-btn reply-submit-btn" onclick="submitReply(${parentId}, this)">ë‹µê¸€ ë“±ë¡</button>
        <button class="mini-btn reply-cancel-btn" onclick="$(this).closest('.reply-input').remove()">ì·¨ì†Œ</button>
      </div>
    </div>
  `;
  const target = $(`button[onclick="replyComment(${parentId})"]`).closest('.comment-actions');
  target.after(replyBox);
}

const replySubmitting = new WeakMap();

function submitReply(parentId, btn) {
  if (replySubmitting.get(btn)) return; // ì´ë¯¸ ë“±ë¡ ì¤‘ì´ë©´ ë¬´ì‹œ

  const replyContent = $(btn).closest('.reply-input').find('.reply-textarea').val();
  if (!replyContent.trim()) {
    alert('ë‹µê¸€ì„ ì…ë ¥í•˜ì„¸ìš”.');
    return;
  }

  replySubmitting.set(btn, true);
  btn.disabled = true;
  btn.textContent = 'ë“±ë¡ ì¤‘...';

  $.ajax({
    url: '/api/comments',
    method: 'POST',
    contentType: 'application/json',
    xhrFields: { withCredentials: true },
    data: JSON.stringify({ content: replyContent, post_id: postId, parent_id: parentId }),
    success: function () {
      loadComments();
    },
    error: function () {
      alert('ë‹µê¸€ ì‘ì„± ì‹¤íŒ¨');
    },
    complete: function() {
      replySubmitting.set(btn, false);
      btn.disabled = false;
      btn.textContent = 'ë‹µê¸€ ë“±ë¡';
    }
  });
}

$(document).ready(function() {
    loadComments();
    initKakaoMap();
});

function initKakaoMap() {
  kakao.maps.load(function() {
    if (latitude && longitude) {
      var mapContainer = document.getElementById('post-map');
      var mapOption = {
        center: new kakao.maps.LatLng(latitude, longitude),
        level: 3
      };
      var map = new kakao.maps.Map(mapContainer, mapOption);
      var marker = new kakao.maps.Marker({
        map: map,
        position: new kakao.maps.LatLng(latitude, longitude)
      });

      var places = new kakao.maps.services.Places();
      var geocoder = new kakao.maps.services.Geocoder();

      places.keywordSearch('ê´€ê´‘ëª…ì†Œ', function(data, status) {
        var placeName = null;
        if (status === kakao.maps.services.Status.OK && data.length > 0) {
          var nearestPlace = findNearestPlace(data, latitude, longitude);
          if (calculateDistance(latitude, longitude, nearestPlace.y, nearestPlace.x) < 1000) {
            placeName = nearestPlace.place_name;
            if (nearestPlace.category_name.includes('ê´€ê´‘ëª…ì†Œ') || 
                nearestPlace.category_name.includes('í…Œë§ˆíŒŒí¬') ||
                nearestPlace.category_name.includes('ë¦¬ì¡°íŠ¸')) {
              placeName = nearestPlace.place_name;
            }
          }
        }
        if (!placeName) {
          places.keywordSearch('', function(generalData, generalStatus) {
            if (generalStatus === kakao.maps.services.Status.OK && generalData.length > 0) {
              var nearestGeneral = findNearestPlace(generalData, latitude, longitude);
              if (calculateDistance(latitude, longitude, nearestGeneral.y, nearestGeneral.x) < 500) {
                placeName = nearestGeneral.place_name;
              }
            }
            if (!placeName) {
              geocoder.coord2Address(longitude, latitude, function(result) {
                var addr = result[0]?.road_address?.address_name || 
                          result[0]?.address?.address_name || 
                          "ì§€ì •í•œ ìœ„ì¹˜";
                showInfoWindow(addr);
              });
            } else {
              showInfoWindow(placeName);
            }
          }, {
            location: new kakao.maps.LatLng(latitude, longitude),
            radius: 2000,
            sort: kakao.maps.services.SortBy.DISTANCE
          });
        } else {
          showInfoWindow(placeName);
        }
      }, {
        location: new kakao.maps.LatLng(latitude, longitude),
        radius: 2000,
        sort: kakao.maps.services.SortBy.DISTANCE
      });

      function showInfoWindow(text) {
        new kakao.maps.InfoWindow({
          content: `<div style="padding:5px;font-size:13px;font-weight:bold;">${text}</div>`
        }).open(map, marker);
      }

      function calculateDistance(lat1, lon1, lat2, lon2) {
        const R = 6371e3;
        const Ï†1 = lat1 * Math.PI/180;
        const Ï†2 = lat2 * Math.PI/180;
        const Î”Ï† = (lat2-lat1) * Math.PI/180;
        const Î”Î» = (lon2-lon1) * Math.PI/180;
        const a = Math.sin(Î”Ï†/2) * Math.sin(Î”Ï†/2) +
                  Math.cos(Ï†1) * Math.cos(Ï†2) *
                  Math.sin(Î”Î»/2) * Math.sin(Î”Î»/2);
        return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      }

      function findNearestPlace(places, targetLat, targetLng) {
        return places.reduce((nearest, current) => {
          const currentDist = calculateDistance(targetLat, targetLng, current.y, current.x);
          const nearestDist = calculateDistance(targetLat, targetLng, nearest.y, nearest.x);
          return currentDist < nearestDist ? current : nearest;
        });
      }
    } else {
      document.getElementById('post-map').style.display = 'none';
    }  
  });
}
document.addEventListener("DOMContentLoaded", function () {
	  const image = document.querySelector(".main-image");
	  const modal = document.getElementById("imageModal");
	  const modalImg = document.getElementById("modalImage");

	  if (image && modal && modalImg) {
	    image.style.cursor = "pointer";
	    image.addEventListener("click", function () {
	      modalImg.src = this.src;
	      modal.style.display = "flex";
	    });
	  }
	});

	function closeModal() {
	  document.getElementById("imageModal").style.display = "none";
	}

	document.addEventListener("DOMContentLoaded", function () {
	  const modal = document.getElementById("previewModal");
	  const previewArea = document.getElementById("previewContent");

	  document.querySelectorAll(".preview-button").forEach(function(btn) {
	    btn.addEventListener("click", function () {
	      const fileId = btn.getAttribute("data-fileid");
	      const fileName = btn.getAttribute("data-filename").toLowerCase();
	      const fileUrl = `/file/preview/${fileId}`;

	      previewArea.innerHTML = ""; // ì´ˆê¸°í™”

	      if (fileName.endsWith(".jpg") || fileName.endsWith(".png") || fileName.endsWith(".jpeg") || fileName.endsWith(".gif") || fileName.endsWith(".webp")) {
	        const img = document.createElement("img");
	        img.src = fileUrl;
	        img.style.maxWidth = "100%";
	        img.style.maxHeight = "80vh";
	        previewArea.appendChild(img);
	      } else if (fileName.endsWith(".pdf")) {
	        const iframe = document.createElement("iframe");
	        iframe.src = fileUrl;
	        iframe.width = "800";
	        iframe.height = "600";
	        previewArea.appendChild(iframe);
	      } else {
	        previewArea.innerHTML = `<p>ì´ íŒŒì¼ì€ ë¯¸ë¦¬ë³´ê¸°ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</p>`;
	      }

	      modal.style.display = "flex";
	    });
	  });
	});

	function closePreviewModal() {
	  document.getElementById("previewModal").style.display = "none";
	}
	document.addEventListener("DOMContentLoaded", function () {
		  const contentModal = document.getElementById("contentImageModal");
		  const modalImg = document.getElementById("contentModalImage");

		  document.querySelectorAll(".view-content img").forEach(function (img) {
		    img.style.cursor = "pointer";
		    img.addEventListener("click", function () {
		      modalImg.src = this.src;
		      contentModal.style.display = "flex";
		    });
		  });
		});

		function closeContentImageModal() {
		  document.getElementById("contentImageModal").style.display = "none";
		}
</script>
</body>
</html>
