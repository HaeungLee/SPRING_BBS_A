<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      th:replace="~{fragments/layout :: layout(~{::title}, ~{::section})}">
  <head>
    <title>게시글 상세</title>
  </head>
  <body>
    <section>
      <div class="post-container">
        <div class="post-header">
          <h2 th:text="${post.title}">제목</h2>
          <div class="post-info">
            <span><i class="fas fa-user"></i> <span th:text="${post.username}">작성자</span></span>
            <span><i class="fas fa-map-marker-alt"></i> <span th:text="${post.region}">지역</span></span>
            <span><i class="fas fa-eye"></i> <span th:text="${post.views}">조회수</span></span>
            <span><i class="fas fa-calendar-alt"></i> <span th:text="${#dates.format(post.created_at, 'yyyy-MM-dd HH:mm')}">작성일</span></span>
          </div>
        </div>
        
        <div class="post-content">
          <p th:text="${post.content}">내용</p>
        </div>
        
        <div class="post-files" th:if="${not #lists.isEmpty(fileList)}">
          <h3>첨부파일</h3>
          <ul>
            <li th:each="file : ${fileList}">
              <a th:href="@{|/file/download/${file.file_id}|}" th:text="${file.original_name}"></a>
            </li>
          </ul>
        </div>
        
        <div class="post-actions">
          <a th:href="@{/post/list}" class="btn btn-secondary">목록으로</a>
          <!-- 수정/삭제 버튼은 작성자만-->
          <div th:if="${session.userId == post.user_id}" class="author-actions">
            <a th:href="@{|/post/edit/${post.post_id}|}" class="btn btn-primary">수정</a>
            <button th:onclick="'if(confirm(\'삭제하시겠습니까?\'))location.href=\'/post/delete/'+${post.post_id}+'\';'" class="btn btn-danger">삭제</button>
          </div>
        </div>

        <div class="comment-section">
          <h3>댓글</h3>
          <div class="comments-list">
            <div th:if="${#lists.isEmpty(commentList)}" class="no-comments">
              <p>아직 댓글이 없습니다.</p>
            </div>
            <div th:each="comment : ${commentList}" class="comment-item">
              <div class="comment-header">
                <span class="comment-author" th:text="${comment.username}">작성자</span>
                <span class="comment-date" th:text="${#dates.format(comment.created_at, 'yyyy-MM-dd HH:mm')}">날짜</span>
              </div>
              <div class="comment-content" th:text="${comment.content}">댓글 내용</div>
              <!-- 댓글 작성자만 수정/삭제-->
              <div th:if="${session.userId == comment.user_id}" class="comment-actions">
                <button th:attr="onclick='editComment(' + ${comment.comment_id} + ', \'' + ${comment.content} + '\')'" class="btn btn-sm btn-primary">수정</button>
                <button th:onclick="'if(confirm(\'댓글을 삭제하시겠습니까?\'))deleteComment('+${comment.comment_id}+');'" class="btn btn-sm btn-danger">삭제</button>
              </div>
            </div>
          </div>
          
          <div class="comment-form">
            <form id="commentForm" th:action="@{|/comment/write/${post.post_id}|}" method="post">
              <textarea id="comment-content" name="content" placeholder="댓글을 입력하세요" required></textarea>
              <button type="submit" class="btn btn-primary">댓글 작성</button>
            </form>
          </div>
        </div>
      </div>

      <style>
        .post-container {
          max-width: 800px;
          margin: 0 auto;
          padding: 20px;
          background-color: #fff;
          box-shadow: 0 0 10px rgba(0,0,0,0.1);
          border-radius: 5px;
        }
        .post-header {
          border-bottom: 1px solid #eee;
          padding-bottom: 10px;
          margin-bottom: 20px;
        }
        .post-info {
          color: #666;
          font-size: 0.9em;
          margin-top: 10px;
        }
        .post-info span {
          margin-right: 15px;
        }
        .post-content {
          line-height: 1.6;
          margin-bottom: 30px;
        }
        .post-files {
          background-color: #f9f9f9;
          padding: 15px;
          border-radius: 5px;
          margin-bottom: 20px;
        }
        .post-files ul {
          list-style-type: none;
          padding-left: 10px;
        }
        .post-files li {
          margin-bottom: 5px;
        }
        .post-actions {
          display: flex;
          justify-content: space-between;
          margin-bottom: 30px;
        }
        .btn {
          padding: 8px 16px;
          border: none;
          border-radius: 4px;
          cursor: pointer;
          font-size: 14px;
          text-decoration: none;
        }
        .btn-primary {
          background-color: #007bff;
          color: white;
        }
        .btn-secondary {
          background-color: #6c757d;
          color: white;
        }
        .btn-danger {
          background-color: #dc3545;
          color: white;
        }
        .btn-sm {
          padding: 4px 8px;
          font-size: 12px;
        }
        .comment-section {
          margin-top: 40px;
        }
        .comment-item {
          border-bottom: 1px solid #eee;
          padding: 10px 0;
          margin-bottom: 10px;
        }
        .comment-header {
          display: flex;
          justify-content: space-between;
          margin-bottom: 5px;
        }
        .comment-author {
          font-weight: bold;
        }
        .comment-date {
          color: #666;
          font-size: 0.8em;
        }
        .comment-content {
          line-height: 1.5;
          margin-bottom: 5px;
        }
        .comment-actions {
          text-align: right;
        }
        .comment-form {
          margin-top: 20px;
        }
        .comment-form textarea {
          width: 100%;
          height: 80px;
          padding: 10px;
          border: 1px solid #ddd;
          border-radius: 4px;
          resize: vertical;
          margin-bottom: 10px;
        }
        .no-comments {
          color: #666;
          font-style: italic;
        }
      </style>

      <script th:inline="javascript">
        function editComment(commentId, content) {
          const newContent = prompt('댓글을 수정해주세요:', content);
          if (newContent && newContent !== content) {
            fetch(`/comment/edit/${commentId}`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRF-TOKEN': document.querySelector('meta[name="_csrf"]').getAttribute('content')
              },
              body: `content=${encodeURIComponent(newContent)}`
            })
            .then(response => {
              if (response.ok) {
                window.location.reload();
              } else {
                alert('댓글 수정에 실패했습니다.');
              }
            });
          }
        }

        function deleteComment(commentId) {
          fetch(`/comment/delete/${commentId}`, {
            method: 'POST',
            headers: {
              'X-CSRF-TOKEN': document.querySelector('meta[name="_csrf"]').getAttribute('content')
            }
          })
          .then(response => {
            if (response.ok) {
              window.location.reload();
            } else {
              alert('댓글 삭제에 실패했습니다.');
            }
          });
        }
      </script>
    </section>
  </body>
</html>
