<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<title>ê²Œì‹œê¸€ ìƒì„¸ë³´ê¸°</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
    body {
        min-height: 100vh;
        margin: 0;
        background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
        font-family: 'Pretendard', 'Segoe UI', Arial, sans-serif;
        color: #222;
    }
    .view-container {
        max-width: 900px;
        margin: 48px auto 0 auto;
        background: #fff;
        border-radius: 20px;
        box-shadow: 0 8px 32px rgba(33,150,243,0.10), 0 1.5px 6px rgba(33,150,243,0.08);
        padding: 36px 36px 28px 36px;
    }
    .view-header {
        margin-bottom: 24px;
        border-bottom: 2px solid #e3f2fd;
        padding-bottom: 12px;
    }
    .view-header h2 {
        margin: 0;
        color: #1565c0;
        font-weight: 800;
        font-size: 2rem;
        letter-spacing: 1px;
    }
    .view-meta {
        font-size: 1rem;
        color: #1976d2;
        margin-top: 8px;
        font-weight: 500;
        display: flex;
        gap: 18px;
        flex-wrap: wrap;
    }
    .main-image-container {
        width: 100%;
        margin: 26px 0 18px 0;
        text-align: center;
    }
    .main-image {
        max-width: 100%;
        max-height: 420px;
        border-radius: 12px;
        box-shadow: 0 2px 12px rgba(33,150,243,0.10);
        background: #f7fbff;
    }
    .view-content {
        margin: 28px 0 24px 0;
        white-space: pre-wrap;
        font-size: 1.08rem;
        color: #222;
        line-height: 1.7;
    }
    #post-map {
        width: 100%;
        height: 320px;
        margin: 18px 0 28px 0;
        border-radius: 12px;
        box-shadow: 0 1.5px 8px rgba(33,150,243,0.06);
        background: #f7fbff;
    }
    .attached-files {
        background-color: #f0f6fb;
        padding: 14px 18px;
        border-radius: 8px;
        margin-top: 18px;
        font-size: 1rem;
        color: #1565c0;
        box-shadow: 0 1px 4px rgba(33,150,243,0.04);
    }
    .attached-files ul {
        padding-left: 18px;
        margin: 8px 0 0 0;
    }
    .attached-files li {
        margin: 4px 0;
        font-size: 0.98rem;
    }
    .attached-files a {
        color: #1976d2;
        text-decoration: underline;
        font-weight: 500;
        transition: color .2s;
    }
    .attached-files a:hover {
        color: #0d47a1;
    }
    .btn-group {
        margin-top: 34px;
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
    }
    .btn {
        padding: 10px 28px;
        border: none;
        border-radius: 999px;
        text-decoration: none;
        color: #fff;
        font-size: 1rem;
        font-weight: 700;
        cursor: pointer;
        box-shadow: 0 2px 8px rgba(33,150,243,0.10);
        transition: background .2s, transform .1s;
        display: inline-block;
    }
    .btn-back {
        background: linear-gradient(90deg, #90caf9 0%, #42a5f5 100%);
        color: #1565c0;
    }
    .btn-back:hover {
        background: linear-gradient(90deg, #42a5f5 0%, #90caf9 100%);
        color: #0d47a1;
    }
    .btn-edit {
        background: linear-gradient(90deg, #2196f3 0%, #1565c0 100%);
    }
    .btn-edit:hover {
        background: linear-gradient(90deg, #1565c0 0%, #2196f3 100%);
    }
    .btn-delete {
        background: linear-gradient(90deg, #e57373 0%, #d32f2f 100%);
    }
    .btn-delete:hover {
        background: linear-gradient(90deg, #d32f2f 0%, #e57373 100%);
    }
    /* ëŒ“ê¸€ ì˜ì—­ */
    .comment-section {
        margin-top: 48px;
        background: #f7fbff;
        border-radius: 14px;
        padding: 28px 22px 22px 22px;
        box-shadow: 0 1.5px 8px rgba(33,150,243,0.06);
    }
    .comment-section h3 {
        margin-top: 0;
        color: #1565c0;
        font-weight: 700;
        font-size: 1.15rem;
        letter-spacing: 0.5px;
    }
    .comment-section textarea {
        width: 100%;
        height: 80px;
        border-radius: 8px;
        border: 1.5px solid #bbdefb;
        padding: 10px;
        font-size: 1rem;
        resize: vertical;
        background: #fff;
        margin-bottom: 8px;
        transition: border .2s;
    }
    .comment-section textarea:focus {
        border: 1.5px solid #42a5f5;
        outline: none;
    }
    .comment-section button {
        background: linear-gradient(90deg, #42a5f5 0%, #1976d2 100%);
        color: #fff;
        border: none;
        border-radius: 999px;
        padding: 7px 22px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: background .2s, transform .1s;
        margin-top: 4px;
    }
    .comment-section button:hover {
        background: linear-gradient(90deg, #1976d2 0%, #42a5f5 100%);
        transform: translateY(-2px) scale(1.04);
    }
    .comment-section a {
        color: #1976d2;
        text-decoration: underline;
        font-weight: 500;
    }
    .comment-section a:hover {
        color: #0d47a1;
    }
    /* ëŒ“ê¸€ ë¦¬ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ */
    #commentList {
        margin-top: 22px;
        font-size: 0.97rem;
        color: #1565c0;
    }
    .comment-block {
        margin-bottom: 22px;
        padding-bottom: 6px;
        border-bottom: 1px solid #e3f2fd;
    }
    .comment-header {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 2px;
    }
    .comment-nickname {
        font-weight: 700;
        color: #1976d2;
        font-size: 1rem;
        margin-right: 2px;
    }
    .comment-like-btn {
        padding: 2px 10px;
        font-size: 0.93rem;
        border-radius: 8px;
        border: none;
        background: #e3f2fd;
        color: #1976d2;
        margin-left: 4px;
        cursor: pointer;
        font-weight: 600;
        transition: background 0.18s, color 0.18s;
        vertical-align: middle;
    }
    .comment-like-btn:hover {
        background: #bbdefb;
        color: #0d47a1;
    }
    .comment-date {
        color: #888;
        font-size: 0.92rem;
        margin-left: 10px;
    }
    .comment-content {
        margin: 2px 0 5px 0;
        color: #222;
        font-size: 1rem;
        word-break: break-all;
    }
    .comment-actions {
        text-align: right;
        margin-top: 2px;
    }
    .comment-reply-btn {
        padding: 2px 8px;
        font-size: 0.82rem;
        border-radius: 7px;
        border: none;
        background: #e3f2fd;
        color: #1976d2;
        margin-left: 2px;
        cursor: pointer;
        font-weight: 500;
        transition: background 0.18s, color 0.18s;
    }
    .comment-reply-btn:hover {
        background: #bbdefb;
        color: #0d47a1;
    }
    .comment-edit-btn, .comment-delete-btn {
        padding: 2px 8px;
        font-size: 0.82rem;
        border-radius: 7px;
        border: none;
        background: #f8bbd0;
        color: #c2185b;
        margin-left: 2px;
        cursor: pointer;
        font-weight: 500;
        transition: background 0.18s, color 0.18s;
    }
    .comment-edit-btn:hover, .comment-delete-btn:hover {
        background: #f06292;
        color: #fff;
    }
    .deleted-comment {
        color: #aaa;
        font-style: italic;
    }
    /* ë‹µê¸€ ì…ë ¥ì°½ ë¯¸ë‹ˆ ìŠ¤íƒ€ì¼ */
    .reply-input {
        margin-top: 8px;
        margin-left: 20px;
        background: #f7fbff;
        border-radius: 8px;
        padding: 8px 10px;
        box-shadow: 0 1px 4px rgba(33,150,243,0.06);
        width: 80%;
    }
    .reply-input textarea {
        width: 96%;
        border-radius: 6px;
        padding: 6px;
        font-size: 0.95rem;
        margin-bottom: 4px;
        border: 1.2px solid #bbdefb;
        resize: vertical;
    }
    .reply-input button {
        padding: 4px 12px;
        font-size: 0.8rem;
        border-radius: 8px;
        border: none;
        background: #e3f2fd;
        color: #1976d2;
        margin-right: 4px;
        cursor: pointer;
        font-weight: 600;
        transition: background 0.18s, color 0.18s;
    }
    .reply-input button:hover {
        background: #bbdefb;
        color: #0d47a1;
    }
    @media (max-width: 600px) {
        .view-container {
            padding: 10px 2vw 18px 2vw;
        }
        .view-header h2 {
            font-size: 1.2rem;
        }
        .main-image {
            max-height: 220px;
        }
        .btn, .btn-group .btn {
            padding: 8px 14px;
            font-size: 0.98rem;
        }
        .attached-files {
            padding: 10px 8px;
            font-size: 0.95rem;
        }
        .comment-section {
            padding: 16px 6px 12px 6px;
        }
        .comment-like-btn, .comment-reply-btn, .comment-edit-btn, .comment-delete-btn, .reply-input button {
            font-size: 0.7rem;
            padding: 2px 7px;
        }
    }
</style>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script type="text/javascript"
    src="//dapi.kakao.com/v2/maps/sdk.js?appkey=6cf3d7111812f0d90ad76a99a16d0f39&autoload=false&libraries=services"></script>
</head>
<body>
    <div class="view-container">
        <div class="view-header">
            <h2 th:utext="${post.title}">ê²Œì‹œê¸€ ì œëª©</h2>
            <div class="view-meta">
                <span>ì‘ì„±ì: <span th:utext="${post.nickname}"></span></span>
                <span>ì§€ì—­: <span th:utext="${post.region}"></span></span>
                <span>ì¡°íšŒìˆ˜: <span th:utext="${post.views}"></span></span>
            </div>
        </div>
        <!-- ë©”ì¸ ì´ë¯¸ì§€ í‘œì‹œ (ì¸ë„¤ì¼ ì´ë¯¸ì§€ë¥¼ í¬ê²Œ í‘œì‹œ) -->
        <div th:if="${mainImage != null}" class="main-image-container">
            <img th:src="@{/file/preview/{fileId}(fileId=${mainImage.fileId})}"
                class="main-image" th:alt="${mainImage.fileOriginName}">
        </div>
        <div class="view-content" th:utext="${post.content}">ê²Œì‹œê¸€ ë‚´ìš©</div>
        <!-- ì§€ë„ í‘œì‹œ ì˜ì—­ ì¶”ê°€ -->
        <div id="post-map"></div>
        <div class="attached-files"
            th:if="${post.files != null and !post.files.isEmpty()}">
            <strong>ì²¨ë¶€íŒŒì¼:</strong>
            <ul>
                <li th:each="file : ${post.files}">
                    <a th:href="@{/file/download/{fileId}(fileId=${file.fileId})}"
                        th:text="${file.fileOriginName}"></a>
                    <span th:text="${#numbers.formatInteger(file.fileSize/1024, 1, 'COMMA')} + ' KB'"></span>
                </li>
            </ul>
        </div>
        <div class="btn-group">
            <a th:href="@{/post/list}" class="btn btn-back">ëª©ë¡ìœ¼ë¡œ</a>
            <th:block th:if="${post.user_id} == ${sessionUserId}">
                <a th:href="@{/post/edit/{id}(id=${post.post_id})}"
                    class="btn btn-edit">ìˆ˜ì •</a>
                <form th:action="@{/post/delete/{id}(id=${post.post_id})}"
                    method="post" style="display: inline;">
                    <button type="submit" class="btn btn-delete"
                        onclick="return confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?');">ì‚­ì œ</button>
                </form>
            </th:block>
        </div>
        <div class="comment-section">
            <h3>ëŒ“ê¸€</h3>
            <div th:if="${user_id != null}">
                <textarea id="commentContent" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
                <br>
                <button onclick="submitComment()">ëŒ“ê¸€ ë“±ë¡</button>
            </div>
            <div th:unless="${user_id != null}">
                <p>
                    ëŒ“ê¸€ì„ ì‘ì„±í•˜ë ¤ë©´ <a th:href="@{/login(returnUrl=${'/post/view/' + post.post_id})}">ë¡œê·¸ì¸</a>ì´ í•„ìš”í•©ë‹ˆë‹¤.
                </p>
            </div>
            <div id="commentList"></div>
        </div>
    </div>
<script th:inline="javascript">
const postId = [[${post.post_id}]];
const currentUserId = [[${user_id}]];
const latitude = [[${post.lat}]];
const longitude = [[${post.lng}]];
const csrfToken = [[${_csrf != null ? _csrf.token : ''}]];
const csrfHeader = [[${_csrf != null ? _csrf.headerName : 'X-CSRF-TOKEN'}]];
const isLoggedIn = [[${session.userId != null}]];

$.ajaxSetup({
  beforeSend: function(xhr) {
    if (csrfToken) {
      xhr.setRequestHeader(csrfHeader, csrfToken);
    }
  }
});

function submitComment() {
  const content = $('#commentContent').val();
  if (!content.trim()) {
    alert('ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”.');
    return;
  }
  $.ajax({
    url: '/api/comments',
    method: 'POST',
    contentType: 'application/json',
    xhrFields: { withCredentials: true },
    data: JSON.stringify({ content: content, post_id: postId }),
    success: function() {
      $('#commentContent').val('');
      loadComments();
    },
    error: function(xhr) {
      if (xhr.status === 401) {
        alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
        window.location.href = '/login';
      } else {
        alert('ëŒ“ê¸€ ë“±ë¡ ì‹¤íŒ¨');
      }
    }
  });
}

function loadComments() {
  $.ajax({
    url: '/api/comments/' + postId,
    method: 'GET',
    success: function(comments) {
      let html = '';
      const commentMap = {};
      comments.forEach(comment => {
        commentMap[comment.comment_id] = comment;
        comment.replies = [];
      });
      const roots = [];
      comments.forEach(comment => {
        if (comment.parent_id) {
          const parent = commentMap[comment.parent_id];
          if (parent) parent.replies.push(comment);
        } else {
          roots.push(comment);
        }
      });
      function renderComments(commentList, depth) {
        commentList.forEach(comment => {
          const marginLeft = depth * 20;
          html += `<div class="comment-block" style="margin-left:${marginLeft}px;">`;
          html += `<div class="comment-header">`;
          html += `<span class="comment-nickname">${comment.nickname || 'ìµëª…'}</span>`;
          if (!comment.is_deleted) {
            html += `<button class="comment-like-btn" onclick="toggleLike(${comment.comment_id})">ğŸ‘ (${comment.like_count || 0})</button>`;
          }
          html += `<span class="comment-date">${comment.created_at?.replace('T', ' ').substring(0,19) || ''}</span>`;
          html += `</div>`;
          if (comment.is_deleted) {
              html += `<div class="deleted-comment">ì‚­ì œëœ ëŒ“ê¸€ì…ë‹ˆë‹¤.</div>`;
          } else {
              html += `<div class="comment-content">${comment.content}</div>`;
          }
          // ë‹µê¸€/ìˆ˜ì •/ì‚­ì œ ë²„íŠ¼
          if (!comment.is_deleted) {
            html += `<div class="comment-actions">`;
            if (currentUserId && comment.user_id === currentUserId) {
              html += `<button class="comment-edit-btn" onclick="editComment(${comment.comment_id}, '${comment.content}')">ìˆ˜ì •</button>`;
              html += `<button class="comment-delete-btn" onclick="deleteComment(${comment.comment_id})">ì‚­ì œ</button>`;
            }
            if (currentUserId) {
              html += `<button class="comment-reply-btn" onclick="replyComment(${comment.comment_id})">ë‹µê¸€</button>`;
            }
            html += `</div>`;
          }
          html += `</div>`;
          if (comment.replies.length > 0) {
            renderComments(comment.replies, depth + 1);
          }
        });
      }
      renderComments(roots, 0);
      $('#commentList').html(html);
    },
    error: function() {
      alert('ëŒ“ê¸€ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨');
    }
  });
}

function toggleLike(commentId) {
  $.ajax({
    url: '/api/comments/' + commentId + '/like',
    method: 'POST',
    xhrFields: { withCredentials: true },
    success: function() {
        loadComments();
    },
    error: function(xhr) {
      if (xhr.status === 401) {
        alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
        window.location.href = '/login';
      } else {
        alert('ì¢‹ì•„ìš” ì‹¤íŒ¨');
      }
    }
  });
}

function deleteComment(commentId) {
  if (!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  $.ajax({
    url: '/api/comments/' + commentId,
    method: 'DELETE',
    xhrFields: { withCredentials: true },
    success: function() {
        loadComments();
    },
    error: function() {
      alert('ëŒ“ê¸€ ì‚­ì œ ì‹¤íŒ¨');
    }
  });
}

function editComment(commentId, oldContent) {
  const newContent = prompt('ëŒ“ê¸€ ìˆ˜ì •:', oldContent);
  if (!newContent || newContent.trim() === '') return;
  $.ajax({
    url: '/api/comments/' + commentId,
    method: 'PUT',
    contentType: 'application/json',
    xhrFields: { withCredentials: true },
    data: JSON.stringify({ content: newContent }),
    success: function() {
        loadComments();
    },
    error: function() {
      alert('ëŒ“ê¸€ ìˆ˜ì • ì‹¤íŒ¨');
    }
  });
}

function replyComment(parentId) {
  $('.reply-input').remove();
  const replyBox = `
    <div class="reply-input">
      <textarea class="reply-textarea" rows="2"></textarea><br>
      <button onclick="submitReply(${parentId}, this)">ë‹µê¸€ ë“±ë¡</button>
      <button onclick="$(this).parent().remove()">ì·¨ì†Œ</button>
    </div>
  `;
  const target = $(`button[onclick="replyComment(${parentId})"]`).closest('.comment-actions');
  target.after(replyBox);
}

function submitReply(parentId, btn) {
  const replyContent = $(btn).siblings('.reply-textarea').val();
  if (!replyContent.trim()) {
    alert('ë‹µê¸€ì„ ì…ë ¥í•˜ì„¸ìš”.');
    return;
  }
  $.ajax({
    url: '/api/comments',
    method: 'POST',
    contentType: 'application/json',
    xhrFields: { withCredentials: true },
    data: JSON.stringify({ content: replyContent, post_id: postId, parent_id: parentId }),
    success: function () {
      loadComments();
    },
    error: function () {
      alert('ë‹µê¸€ ì‘ì„± ì‹¤íŒ¨');
    }
  });
}

$(document).ready(function() {
    loadComments();
    initKakaoMap();
});

// ì¹´ì¹´ì˜¤ë§µ ê´€ë ¨ í•¨ìˆ˜
function initKakaoMap() {
  kakao.maps.load(function() {
    if (latitude && longitude) {
      var mapContainer = document.getElementById('post-map');
      var mapOption = {
        center: new kakao.maps.LatLng(latitude, longitude),
        level: 3
      };
      var map = new kakao.maps.Map(mapContainer, mapOption);
      var marker = new kakao.maps.Marker({
        map: map,
        position: new kakao.maps.LatLng(latitude, longitude)
      });

      var places = new kakao.maps.services.Places();
      var geocoder = new kakao.maps.services.Geocoder();

      places.keywordSearch('ê´€ê´‘ëª…ì†Œ', function(data, status) {
        var placeName = null;
        if (status === kakao.maps.services.Status.OK && data.length > 0) {
          var nearestPlace = findNearestPlace(data, latitude, longitude);
          if (calculateDistance(latitude, longitude, nearestPlace.y, nearestPlace.x) < 1000) {
            placeName = nearestPlace.place_name;
            if (nearestPlace.category_name.includes('ê´€ê´‘ëª…ì†Œ') || 
                nearestPlace.category_name.includes('í…Œë§ˆíŒŒí¬') ||
                nearestPlace.category_name.includes('ë¦¬ì¡°íŠ¸')) {
              placeName = nearestPlace.place_name;
            }
          }
        }
        if (!placeName) {
          places.keywordSearch('', function(generalData, generalStatus) {
            if (generalStatus === kakao.maps.services.Status.OK && generalData.length > 0) {
              var nearestGeneral = findNearestPlace(generalData, latitude, longitude);
              if (calculateDistance(latitude, longitude, nearestGeneral.y, nearestGeneral.x) < 500) {
                placeName = nearestGeneral.place_name;
              }
            }
            if (!placeName) {
              geocoder.coord2Address(longitude, latitude, function(result) {
                var addr = result[0]?.road_address?.address_name || 
                          result[0]?.address?.address_name || 
                          "ì§€ì •í•œ ìœ„ì¹˜";
                showInfoWindow(addr);
              });
            } else {
              showInfoWindow(placeName);
            }
          }, {
            location: new kakao.maps.LatLng(latitude, longitude),
            radius: 2000,
            sort: kakao.maps.services.SortBy.DISTANCE
          });
        } else {
          showInfoWindow(placeName);
        }
      }, {
        location: new kakao.maps.LatLng(latitude, longitude),
        radius: 2000,
        sort: kakao.maps.services.SortBy.DISTANCE
      });

      function showInfoWindow(text) {
        new kakao.maps.InfoWindow({
          content: `<div style="padding:5px;font-size:13px;font-weight:bold;">${text}</div>`
        }).open(map, marker);
      }

      function calculateDistance(lat1, lon1, lat2, lon2) {
        const R = 6371e3;
        const Ï†1 = lat1 * Math.PI/180;
        const Ï†2 = lat2 * Math.PI/180;
        const Î”Ï† = (lat2-lat1) * Math.PI/180;
        const Î”Î» = (lon2-lon1) * Math.PI/180;
        const a = Math.sin(Î”Ï†/2) * Math.sin(Î”Ï†/2) +
                  Math.cos(Ï†1) * Math.cos(Ï†2) *
                  Math.sin(Î”Î»/2) * Math.sin(Î”Î»/2);
        return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      }

      function findNearestPlace(places, targetLat, targetLng) {
        return places.reduce((nearest, current) => {
          const currentDist = calculateDistance(targetLat, targetLng, current.y, current.x);
          const nearestDist = calculateDistance(targetLat, targetLng, nearest.y, nearest.x);
          return currentDist < nearestDist ? current : nearest;
        });
      }
    } else {
      document.getElementById('post-map').style.display = 'none';
    }  
  });
}
</script>
</body>
</html>
