<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.bbs.demo.mapper.CommentMapper">
<!-- 
    <select id="getCommentsByPostId" resultType="com.bbs.demo.model.Comment">
        SELECT * FROM comments
        WHERE post_id = #{post_id} AND is_deleted = false
        ORDER BY created_at ASC
    </select> -->
<select id="getCommentsByPostId" resultType="com.bbs.demo.model.Comment">
    SELECT c.comment_id,c.content,c.created_at,c.updated_at,c.user_id,c.post_id,c.is_deleted,
        c.like_count,c.parent_id,u.nickname,u.profile_img
    FROM comments c
    LEFT JOIN users u ON c.user_id = u.user_id
    WHERE c.post_id = #{post_id} AND c.is_deleted = false
    ORDER BY c.created_at ASC
</select>
    

    <select id="getRepliesByParentId" resultType="com.bbs.demo.model.Comment">
        SELECT * FROM comments
        WHERE parent_id = #{parent_id} AND is_deleted = false
        ORDER BY created_at ASC
    </select>

    <insert id="insertComment" parameterType="com.bbs.demo.model.Comment">
        INSERT INTO comments (content, created_at, updated_at, user_id, post_id, parent_id, is_deleted, like_count)
        VALUES (#{content}, NOW(), NOW(), #{user_id}, #{post_id}, #{parent_id}, false, 0)
    </insert>

    <update id="updateComment" parameterType="com.bbs.demo.model.Comment">
        UPDATE comments
        SET content = #{content}, updated_at = NOW()
        WHERE comment_id = #{comment_id}
    </update>

    <update id="markCommentAsDeleted">
        UPDATE comments
        SET is_deleted = true, updated_at = NOW()
        WHERE comment_id = #{id} AND user_id = #{user_id}
    </update>

    <select id="getCommentById" resultType="com.bbs.demo.model.Comment">
        SELECT * FROM comments
        WHERE comment_id = #{id}
    </select>

    <update id="incrementLikeCount">
        UPDATE comments
        SET like_count = like_count + 1
        WHERE comment_id = #{id}
    </update>

    <update id="decrementLikeCount">
        UPDATE comments
        SET like_count = like_count - 1
        WHERE comment_id = #{id} AND like_count > 0
    </update>

</mapper>